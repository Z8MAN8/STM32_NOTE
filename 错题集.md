# 错题集

 *记录在rm战队中，以及嵌入式学习之路上所遇到的问题和进去过的坑，希望这些能让我变得更强大。*

- 通信协议（openmv）
- 串口多机通信  RS485
-  软件uart
-   freertos 内存大小问题：在搭建代码框架的时候，之前创建的 freertos 任务都是可以正常运行的，但是新建的任务就出现了问题，调试的时候发现一直不进新建的任务，修改了任务优先级，延时时长都不行。之后查看了任务调度状态发现了异常，转到新建任务的创建部分进行调试，发现任务句柄为空，创建任务失败。调整了任务创建的先后顺序，发现先创建的任务正常，后创建的任务异常。怀疑是内存分配不足，导致可以正常创建的任务数量少，随后转到 FreeRTOSConfig.h 文件更改 configTOTAL_HEAP_SIZE 的大小，重新调试，所有任务正常创建和运行，成功解决问题。
-  每次使用 cubeMX 更新设置以后，都要记得补充 CmakeList ，以及修改 FreeRTOSConfig.h 文件，以及其他会被重置的设置，否则许多之前修好的bug会重现。
-  电赛在调小车的时候，使用了 TB6612 驱动模块和 STM32F103C8T6 最小系统板，一开始是调单独一个电机的 PID 的时候，接着有线调试器调好的参数，拔了调试器脱机运行就不行了，导致这个问题的原因是接了调试器以后，需要注意主控的供电，否则可能导致电压差异，导致调试时和脱机时电机转动不同，或者直接使用无限调试器，也能避免这个问题。
-  电赛调小车电机的时候还遇到一个比较玄学的问题，就是两个电机的编码器， TIM2 读取正常，但是 TIM1 的 CNT 就随机波动，交换以后 TIM1 仍旧异常，甚至把电机的线拔了以后 TIM1 还是随机波动。一开始以为是两个电机的霍尔编码器距离太近产生干扰，于是尝试在中间插入一块铁片，还尝试将电机拆下相互远离，但问题依旧存在。最终将 TB6612 驱动板和主控的供电相互分开以后，编码器才能终于正常。由于疫情隔离在家，工具不足，经过反复实验，认为问题所在是因为电机转动产生的电压波动，且通过驱动板与主控之间供电的连接，影响了主控，导致主控 TIM1 引脚电压波动异常，得出异常结果。经过此次经验，对于电机这类可能产生电压波动的外设，需要注意对主控的反向影响，最好将其与主控的供电分离开，或者使用二极管之类的单向导通。否则容易出现一些诡异，不易找到源头的异常。
- STM32F103C8T6 在做电赛小车时，定义了 PA11 和 PA12 两个引脚分别作为两个按键的外部中断，使用的均为 EXTI line[15:10] interrupts 但是在实际使用时，按动一个按键会进入两次中断，在 HAL_GPIO_EXTI_Callback 函数中已经对 GPIO_Pin 进行了判断，但是会每次执行不同中断中的语句。经过 debug 发现，是 cubeMX 生成的 stm32f1xx_it.c 文件中的 void EXTI15_10_IRQHandler(void) 函数中，有以下两个语句：

  ```c
  void EXTI15_10_IRQHandler(void)
  {
    /* USER CODE BEGIN EXTI15_10_IRQn 0 */
  
    /* USER CODE END EXTI15_10_IRQn 0 */
    HAL_GPIO_EXTI_IRQHandler(KEY1_Pin);
    HAL_GPIO_EXTI_IRQHandler(KEY2_Pin);
    /* USER CODE BEGIN EXTI15_10_IRQn 1 */
  
    /* USER CODE END EXTI15_10_IRQn 1 */
  }
  ```

  这样导致程序无法准确识别是哪一个引脚触发了外部中断，会触发 EXTI line[15:10] interrupts  中的所有中断。

  解决方案是在 void EXTI15_10_IRQHandler(void) 函数中只保留一个 HAL_GPIO_EXTI_IRQHandler(); 语句，然后在 HAL_GPIO_EXTI_Callback 函数中判断具体的引脚。
  
  2022\11\6
