# 嵌入式环境下的C语言使用技巧



## 位（bit）操作

在嵌入式程序开发中，灵活的位操作可以有效提高程序运行的效率。特别是除法和取模运算：

```
/*对于以2的指数次方为因子的数学运算*/

/*方法1*/
unsigned int i,j;
i = 156 / 16;
j = 562 % 32;

/*方法2*/
unsigned int i,j;
i = 156 >> 4;
j = 562 - (562 >> 5 << 5);
```

移位操作分为左移位和右移位。左移位就是在右边空出的位置补零。右移位又分为算数右移和逻辑右移，**无符号数**默认是**逻辑右移**，有符号为算数右移；逻辑右移就是在左边补零，算术右移是补之前的最高位。

位操作还有一个重要作用是实现位间的与（&）、或（|）、非（~）操作。



### 数据指针

借助C语言指针具有的对绝对地址单元内容的读写能力，直接操作寄存器。

需要注意**处理器**是以**字节为单位**编址，而**C语言指针**以指向的**数据类型长度**做自增和自减。



## 函数等价于指令的集合

1. 语言中函数名直接对应于函数生成的指令代码在内存中的地址
2. 调用函数实际上等同于“**调转指令+参数传递处理+回归位置入栈**”
3. 可以调用一个没有函数实体的函数，本质上只是换了一个地址开始执行指令



## 操作有限的存储空间

1. 一定要保证 malloc 和 free 语句成对出现。
2. 不要用指针动态申请存储空间。
3. 尽可能的选用数组，数组不能越界访问
4. 如果使用动态申请，则申请后一定要判断是否申请成功了



## 栈空间（Stack）和堆空间（Heap）

栈区由编译程序自动分配，存放函数的参数值，局部变量的值等，操作方式类似于数据结构中的栈。

堆区一般由程序员分配，和数据结构中的堆是不一样的，分配方式类似于链表。

在嵌入式开发中，如果需要的存储空间较大，应优先考虑采用动态分配存储空间的策略；如果需要的空间较小，直接采用数组方式分配效率更高。



## 关键词 const（只读）

编译阶段不能用到变量，在编译阶段需要的常数仍然只能以 #define 定义



## 关键词 volatile

volatile 可以防止编译程序的一些优化，常用于如下情况：

1. 并行设别的硬件寄存器
2. 一个中断服务子程序中会访问到的非自动变量（全局变量）
3. 多线程应用中被几个任务共享的变量



## 处理器字长于内存位宽不一致处理

在嵌入式应用开发中必须考虑这个问题



## 熟练使用 struct{ } 结构体

可以极大的优化代码结构，易读且易修改。

例如：

```
(char *) &sendCommuPacket //先取地址，再转化为 char 类型指针，可以直接利用处理字节流的函数
```

